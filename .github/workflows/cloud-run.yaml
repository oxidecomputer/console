name: Preview

on:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - "main"
    types: [synchronize, opened, reopened]

env:
  PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
  RUN_REGION: us-central1
  SERVICE_NAME: omicron-console-dev

jobs:
  container:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Cache Docker layers
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@master
        with:
          project_id: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
          service_account_key: ${{ secrets.GOOGLE_CLOUD_SA_KEY }}
      - name: Login to GitHub Packages Docker Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.GLOBAL_GITHUB_TOKEN }}
      - name: Install Google Cloud Docker
        run: gcloud components install docker-credential-gcr
      - name: Setup Docker for GCR
        run: gcloud auth configure-docker
      - name: Build and push
        uses: docker/build-push-action@v2
        with:
          push: true
          file: ./ci/omicron/Dockerfile
          tags: gcr.io/${PROJECT_ID}/${SERVICE_NAME}:pr-${{github.event.number}}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache

  preview:
    runs-on: ubuntu-latest
    needs: [container]
    steps:
      - uses: actions/checkout@v2
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@master
        with:
          project_id: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
          service_account_key: ${{ secrets.GOOGLE_CLOUD_SA_KEY }}
      - name: Get HEAD Commit Hash
        id: commit
        run: echo "::set-output name=hash::$(git rev-parse --short HEAD)"
      - name: Deploy Revision On Cloud Run
        run: |
          gcloud run deploy "$SERVICE_NAME" \
          --image "gcr.io/$PROJECT_ID/$SERVICE_NAME:pr-${{github.event.number}} \
          --region "$RUN_REGION" \
          --platform=managed \
          --port=3000 \
          --revision-suffix=${{github.event.number}}-${{steps.commit.outputs.hash}} \
          --allow-unauthenticated \
          --max-instances=1
      - name: Update Traffic
        run: |
          gcloud components install beta
          gcloud beta run services update-traffic "$SERVICE_NAME" \
            --update-tags pr-${{github.event.number}}=${SERVICE_NAME}-${{github.event.number}}-${{steps.commit.outputs.hash}} \
            --platform=managed \
            --region "$RUN_REGION" \
      - name: Get Preview URL
        id: preview-url
        run: |
          url=$(gcloud run services describe $SERVICE_NAME --format 'value(status.url)' --platform=managed --region=${RUN_REGION} | sed 's|https://|https://pr-${{github.event.number}}---|g')
          echo "::set-output name=url::$url"
      - name: Post PR comment with preview deployment URL
        uses: mshick/add-pr-comment@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          message: |
            Successfully deployed preview at ${{steps.preview-url.outputs.url}}
          allow-repeats: false
